#!/usr/bin/env bash
echo '{"version":1, "click_events":true}'
echo '['
echo '[],'

exec 3<&0

handle_clicks() {
    while read -r line <&3; do
        if echo "$line" | grep -q '"name": "lock"'; then
            swaylock &
        elif echo "$line" | grep -q '"name": "notifications"'; then
            local notification_id=$(dunstctl history | jq '[.data[][] | select(.timeout.data > 0 and .urgency.data != "LOW") | .id.data] | first')
            
            if [ -n "$notification_id" ]; then
                dunstctl history-pop "$notification_id"
            fi
        fi
    done
}

handle_clicks &

battery() {
    local battery="/sys/class/power_supply/BAT*"
    local battery_capacity=$(cat $battery/capacity)
    local battery_state=$(cat $battery/status)

    if [ "$battery_state" = "Discharging" ]; then
        if [ "$battery_capacity" -gt 90 ]; then
            echo -n '"full_text":"󰁹"'
        elif [ "$battery_capacity" -gt 80 ]; then
            echo -n '"full_text":"󰂂"'
        elif [ "$battery_capacity" -gt 70 ]; then
            echo -n '"full_text":"󰂁"'
        elif [ "$battery_capacity" -gt 60 ]; then
            echo -n '"full_text":"󰂀"'
        elif [ "$battery_capacity" -gt 50 ]; then
            echo -n '"full_text":"󰁿"'
        elif [ "$battery_capacity" -gt 40 ]; then
            echo -n '"full_text":"󰁽", "color": "ffd866"'
        elif [ "$battery_capacity" -gt 30 ]; then
            echo -n '"full_text":"󰁽", "color": "ffd866"'
        elif [ "$battery_capacity" -gt 20 ]; then
            echo -n '"full_text":"󰁼", "color": "ff6188"'
        elif [ "$battery_capacity" -gt 10 ]; then
            echo -n '"full_text":"󰁻", "color": "ff6188"'
        else
            echo -n '"full_text":"󰁺", "color": "ff6188"'
        fi
    else
        if [ "$battery_capacity" -gt 90 ]; then
            echo -n '"full_text":"󰂅"'
        elif [ "$battery_capacity" -gt 80 ]; then
            echo -n '"full_text":"󰂋"'
        elif [ "$battery_capacity" -gt 70 ]; then
            echo -n '"full_text":"󰂊"'
        elif [ "$battery_capacity" -gt 60 ]; then
            echo -n '"full_text":"󰢞"'
        elif [ "$battery_capacity" -gt 50 ]; then
            echo -n '"full_text":"󰂉"'
        elif [ "$battery_capacity" -gt 40 ]; then
            echo -n '"full_text":"󰢝"'
        elif [ "$battery_capacity" -gt 30 ]; then
            echo -n '"full_text":"󰂈"'
        elif [ "$battery_capacity" -gt 20 ]; then
            echo -n '"full_text":"󰂇"'
        elif [ "$battery_capacity" -gt 10 ]; then
            echo -n '"full_text":"󰂆"'
        else
            echo -n '"full_text":"󰢜"'
        fi
    fi
}

wifi() {
    local wifi_info=$(nmcli -t -f in-use,ssid,signal dev wifi | grep '*')
    local SSID=$(echo $wifi_info | cut -d: -f2)
    local STRENGTH=$(echo $wifi_info | cut -d: -f3)

    if [[ -z "$SSID" ]]; then
        echo -n '"full_text":"󰤭", "color": "ff6188"'
    else
        if [ "$STRENGTH" -gt 75 ]; then
            echo -n "\"full_text\":\"󰤨 <small>"$SSID"</small>\""
        elif [ "$STRENGTH" -gt 50 ]; then
            echo -n "\"full_text\":\"󰤥 <small>"$SSID"</small>\""
        elif [ "$STRENGTH" -gt 25 ]; then
            echo -n "\"full_text\":\"󰤢 <small>"$SSID"</small>\""
        else
            echo -n "\"full_text\":\"󰤟 <small>"$SSID"</small>\""
        fi
    fi
}


bluetooth() {
    local connections=$(bluetoothctl devices Connected | wc -l)
    local icons=$(bluetoothctl devices Connected | cut -c 8-24 | xargs -I{} bluetoothctl info {} | grep -i icon | awk -F': ' '{print $2}')

    if [ "$connections" -gt 0 ]; then
        echo -n "\"full_text\":\"󰂱 <small> "

        for i in $icons; do
            echo -n "$(_bluetooth_type_to_icon $i) "
        done

        echo -n '</small>"'
    else
        echo -n '"full_text":"󰂯"'
    fi
}

notifications() {
    local unread_count=$(dunstctl history | jq '[.data[][] | select(.timeout.data > 0 and .urgency.data != "LOW")] | length')
    local is_paused=$(dunstctl is-paused)

    if [ "$is_paused" = "true" ]; then
        echo -n "\"full_text\":\"󰂛\",\"color\":\"78dce8\""
    elif [ "$unread_count" -gt 0 ]; then
        echo -n "\"full_text\":\"󱅫 <small>"$unread_count"</small>\",\"color\":\"ff6188\""
    else
        echo -n "\"full_text\":\"󰂚\""
    fi
}

volume() {
    local volume=$(wpctl get-volume @DEFAULT_SINK@ | awk -F'.' '{print $2}')
    local name=$(wpctl inspect @DEFAULT_SINK@ | grep -i node.description | awk -F\" '{ print $2}' | cut -d " " -f 1-3)

    if echo "$volume" | grep -qi "muted"; then
        echo -n "\"full_text\":\"󰖁\""
    elif [ "$volume" -gt 66 ]; then
        echo -n "\"full_text\":\"󰕾 <small>"$name" ("$volume"%)</small>\""
    elif [ "$volume" -gt 33 ]; then
        echo -n "\"full_text\":\"󰖀 <small>"$name" ("$volume"%)</small>\""
    else
        echo -n "\"full_text\":\"󰕿 <small>"$name" ("$volume"%)</small>\""
    fi
}

date_time() {
    local datetime=$(date '+%d %B, %H:%M')

    echo -n "\"full_text\":\"<b>󰸘 <small>$datetime</small></b>\", \"color\":\"#78dce8\""
}

pkg_updates() {
    echo -n "$(cat /tmp/pkgs-updates-count 2>/dev/null || echo -n 0)"
}

_bluetooth_type_to_icon() {
    case $1 in
        "input-keyboard") echo -n "󰌌" ;;
        "input-mouse") echo -n "󰍽" ;;
        "audio-card") echo -n "󰓃" ;;
        *) echo -n "" ;;
    esac
}

while :; do
    datetime=$(date_time)
    battery=$(battery)
    wifi=$(wifi)
    bluetooth=$(bluetooth)
    notifications=$(notifications)
    volume=$(volume)
    pkg_count=$(pkg_updates)

    echo -n '['
    echo -n "{"$datetime", \"min_width\":30, \"separator\": true, \"separator_block_width\":20, \"markup\":\"pango\"}"

    if [ "$pkg_count" -gt 0 ]; then
        echo -n ",{\"full_text\":\"󰚰 <small>"$pkg_count"</small>\", \"color\":\"#a9dc76\", \"min_width\":30, \"align\":\"center\", \"separator\": true, \"separator_block_width\":23, \"markup\":\"pango\"}"
    fi

    echo -n ",{"$notifications", \"min_width\":30, \"align\":\"center\", \"separator\": true, \"separator_block_width\":23, \"markup\":\"pango\", \"name\":\"notifications\"}"
    echo -n ",{"$bluetooth", \"min_width\":30, \"align\":\"center\", \"separator\": true, \"separator_block_width\":20, \"markup\":\"pango\"}"
    echo -n ",{"$wifi", \"min_width\":30, \"align\":\"center\", \"separator\": true, \"separator_block_width\":25, \"markup\":\"pango\"}"
    echo -n ",{"$volume", \"min_width\":30, \"align\":\"center\", \"separator\": true, \"separator_block_width\":25, \"markup\":\"pango\"}"
    echo -n ",{"$battery", \"separator\": false}"
    echo '],'
    sleep 1
done
