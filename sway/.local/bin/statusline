#!/usr/bin/env bash
echo '{"version":1, "click_events":true}'
echo '['
echo '[],'

exec 3<&0

handle_clicks() {
    while read -r line <&3; do
        if echo "$line" | grep -q '"name": "lock"'; then
            swaylock &
        elif echo "$line" | grep -q '"name": "notifications"'; then
            local notification_id=$(dunstctl history | jq '[.data[][] | select(.timeout.data > 0 and .urgency.data != "LOW") | .id.data] | first')
            
            if [ -n "$notification_id" ]; then
                dunstctl history-pop "$notification_id"
            fi
        fi
    done
}

handle_clicks &

battery() {
    local battery="/sys/class/power_supply/BAT*"
    local battery_capacity=$(cat $battery/capacity)
    local battery_state=$(cat $battery/status)

    if [ "$battery_state" = "Discharging" ]; then
        if [ "$battery_capacity" -gt 90 ]; then
            echo -n '"full_text":"󰁹"'
        elif [ "$battery_capacity" -gt 80 ]; then
            echo -n '"full_text":"󰂂"'
        elif [ "$battery_capacity" -gt 70 ]; then
            echo -n '"full_text":"󰂁"'
        elif [ "$battery_capacity" -gt 60 ]; then
            echo -n '"full_text":"󰂀"'
        elif [ "$battery_capacity" -gt 50 ]; then
            echo -n '"full_text":"󰁿"'
        elif [ "$battery_capacity" -gt 40 ]; then
            echo -n '"full_text":"󰁽", "color": "ffd866"'
        elif [ "$battery_capacity" -gt 30 ]; then
            echo -n '"full_text":"󰁽", "color": "ffd866"'
        elif [ "$battery_capacity" -gt 20 ]; then
            echo -n '"full_text":"󰁼", "color": "ff6188"'
        elif [ "$battery_capacity" -gt 10 ]; then
            echo -n '"full_text":"󰁻", "color": "ff6188"'
        else
            echo -n '"full_text":"󰁺", "color": "ff6188"'
        fi
    else
        if [ "$battery_capacity" -gt 90 ]; then
            echo -n '"full_text":"󰂅"'
        elif [ "$battery_capacity" -gt 80 ]; then
            echo -n '"full_text":"󰂋"'
        elif [ "$battery_capacity" -gt 70 ]; then
            echo -n '"full_text":"󰂊"'
        elif [ "$battery_capacity" -gt 60 ]; then
            echo -n '"full_text":"󰢞"'
        elif [ "$battery_capacity" -gt 50 ]; then
            echo -n '"full_text":"󰂉"'
        elif [ "$battery_capacity" -gt 40 ]; then
            echo -n '"full_text":"󰢝"'
        elif [ "$battery_capacity" -gt 30 ]; then
            echo -n '"full_text":"󰂈"'
        elif [ "$battery_capacity" -gt 20 ]; then
            echo -n '"full_text":"󰂇"'
        elif [ "$battery_capacity" -gt 10 ]; then
            echo -n '"full_text":"󰂆"'
        else
            echo -n '"full_text":"󰢜"'
        fi
    fi
}

wifi() {
    local SSID=$(nmcli -t -f in-use,ssid dev wifi | grep '*' | cut -d: -f2)
    local STRENGTH=$(nmcli -t -f in-use,ssid,signal dev wifi | grep '*' | cut -d: -f3)

    if [[ -z "$SSID" ]]; then
        echo -n '"full_text":"󰤭", "color": "ff6188"'
    else
        if [ "$STRENGTH" -gt 75 ]; then
            echo -n "\"full_text\":\"󰤨 <small>"$SSID"</small>\""
        elif [ "$STRENGTH" -gt 50 ]; then
            echo -n "\"full_text\":\"󰤥 <small>"$SSID"</small>\""
        elif [ "$STRENGTH" -gt 25 ]; then
            echo -n "\"full_text\":\"󰤢 <small>"$SSID"</small>\""
        else
            echo -n "\"full_text\":\"󰤟 <small>"$SSID"</small>\""
        fi
    fi
}

bluetooth() {
    local connections=$(bluetoothctl devices Connected | wc -l)

    if [ "$connections" -gt 0 ]; then
        echo -n "\"full_text\":\"󰂱 <small>"$connections"</small>\""
    else
        echo -n '"full_text":"󰂯"'
    fi
}

notifications() {
    local unread_count=$(dunstctl history | jq '[.data[][] | select(.timeout.data > 0 and .urgency.data != "LOW")] | length')
    local is_paused=$(dunstctl is-paused)

    if [ "$is_paused" = "true" ]; then
        echo -n "\"full_text\":\"󰂛\",\"color\":\"78dce8\""
    elif [ "$unread_count" -gt 0 ]; then
        echo -n "\"full_text\":\"󱅫 <small>"$unread_count"</small>\",\"color\":\"ff6188\""
    else
        echo -n "\"full_text\":\"󰂚\""
    fi
}

volume() {
    local volume=$(wpctl get-volume @DEFAULT_SINK@ | awk -F'.' '{print $2}')

    if echo "$volume" | grep -qi "muted"; then
        echo -n "\"full_text\":\"󰖁\""
    elif [ "$volume" -gt 66 ]; then
        echo -n "\"full_text\":\"󰕾 <small>"$volume"%</small>\""
    elif [ "$volume" -gt 33 ]; then
        echo -n "\"full_text\":\"󰖀 <small>"$volume"%</small>\""
    else
        echo -n "\"full_text\":\"󰕿 <small>"$volume"%</small>\""
    fi
}

while :; do
    datetime=$(date '+%d %b %H:%M')
    battery=$(battery)
    wifi=$(wifi)
    bluetooth=$(bluetooth)
    notifications=$(notifications)
    volume=$(volume)

    echo -n '['
    echo -n "{\"full_text\":\"$datetime\", \"min_width\":30, \"separator\": true, \"separator_block_width\":20}"
    echo -n ",{"$notifications", \"min_width\":30, \"align\":\"center\", \"separator\": true, \"separator_block_width\":23, \"markup\":\"pango\", \"name\":\"notifications\"}"
    echo -n ",{"$bluetooth", \"min_width\":30, \"align\":\"center\", \"separator\": true, \"separator_block_width\":20, \"markup\":\"pango\"}"
    echo -n ",{"$wifi", \"min_width\":30, \"align\":\"center\", \"separator\": true, \"separator_block_width\":25, \"markup\":\"pango\"}"
    echo -n ",{"$volume", \"min_width\":30, \"align\":\"center\", \"separator\": true, \"separator_block_width\":25, \"markup\":\"pango\"}"
    echo -n ",{"$battery", \"separator\": false}"
    #echo -n ',{"full_text":"", "name":"lock", "separator": false}'
    echo '],'
    sleep 1
done
