#!/usr/bin/env bash
echo '{"version":1, "click_events":true}'
echo '['
echo '[],'

exec 3<&0

handle_clicks() {
    while read -r line <&3; do
        if echo "$line" | grep -q '"name": "lock"'; then
            swaylock &
        fi
    done
}

handle_clicks &

battery() {
    local battery="/sys/class/power_supply/BAT*"
    local battery_capacity=$(cat $battery/capacity)
    local battery_state=$(cat $battery/status)

    if [ "$battery_state" = "Discharging" ]; then
        if [ "$battery_capacity" -gt 90 ]; then
            echo -n '"full_text":"󰁹"'
        elif [ "$battery_capacity" -gt 80 ]; then
            echo -n '"full_text":"󰂂"'
        elif [ "$battery_capacity" -gt 70 ]; then
            echo -n '"full_text":"󰂁"'
        elif [ "$battery_capacity" -gt 60 ]; then
            echo -n '"full_text":"󰂀"'
        elif [ "$battery_capacity" -gt 50 ]; then
            echo -n '"full_text":"󰁿"'
        elif [ "$battery_capacity" -gt 40 ]; then
            echo -n '"full_text":"󰁽", "color": "ffd866"'
        elif [ "$battery_capacity" -gt 30 ]; then
            echo -n '"full_text":"󰁽", "color": "ffd866"'
        elif [ "$battery_capacity" -gt 20 ]; then
            echo -n '"full_text":"󰁼", "color": "ff6188"'
        elif [ "$battery_capacity" -gt 10 ]; then
            echo -n '"full_text":"󰁻", "color": "ff6188"'
        else
            echo -n '"full_text":"󰁺", "color": "ff6188"'
        fi
    else
        if [ "$battery_capacity" -gt 90 ]; then
            echo -n '"full_text":"󰂅"'
        elif [ "$battery_capacity" -gt 80 ]; then
            echo -n '"full_text":"󰂋"'
        elif [ "$battery_capacity" -gt 70 ]; then
            echo -n '"full_text":"󰂊"'
        elif [ "$battery_capacity" -gt 60 ]; then
            echo -n '"full_text":"󰢞"'
        elif [ "$battery_capacity" -gt 50 ]; then
            echo -n '"full_text":"󰂉"'
        elif [ "$battery_capacity" -gt 40 ]; then
            echo -n '"full_text":"󰢝"'
        elif [ "$battery_capacity" -gt 30 ]; then
            echo -n '"full_text":"󰂈"'
        elif [ "$battery_capacity" -gt 20 ]; then
            echo -n '"full_text":"󰂇"'
        elif [ "$battery_capacity" -gt 10 ]; then
            echo -n '"full_text":"󰂆"'
        else
            echo -n '"full_text":"󰢜"'
        fi
    fi
}

wifi() {
    local SSID=$(nmcli -t -f in-use,ssid dev wifi | grep '*' | cut -d: -f2)
    local STRENGTH=$(nmcli -t -f in-use,ssid,signal dev wifi | grep '*' | cut -d: -f3)

    if [[ -z "$SSID" ]]; then
        echo -n '"full_text":"󰤭", "color": "ff6188"'
    else
        if [ "$STRENGTH" -gt 75 ]; then
            echo -n '"full_text":"󰤨"'
        elif [ "$STRENGTH" -gt 50 ]; then
            echo -n '"full_text":"󰤥"'
        elif [ "$STRENGTH" -gt 25 ]; then
            echo -n '"full_text":"󰤢"'
        else
            echo -n '"full_text":"󰤟"'
        fi
    fi
}

bluetooth() {
    local any_connected=$(bluetoothctl devices Connected)

    if [[ -z "$any_connected" ]]; then
        echo -n '"full_text":"󰂯"'
    else
        echo -n '"full_text":"󰂱"'
    fi
}

while :; do
    datetime=$(date '+%d %b %H:%M')
    battery=$(battery)
    wifi=$(wifi)
    bluetooth=$(bluetooth)

    echo -n '['
    echo -n "{\"full_text\":\"$datetime\", \"separator\": false, \"separator_block_width\":20}"
    echo -n ",{"$bluetooth", \"separator\": false, \"separator_block_width\":20}"
    echo -n ",{"$wifi", \"separator\": false, \"separator_block_width\":25}"
    echo -n ",{"$battery", \"separator\": false}"
    #echo -n ',{"full_text":"", "name":"lock", "separator": false}'
    echo '],'
    sleep 1
done
