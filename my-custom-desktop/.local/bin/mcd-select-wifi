#!/usr/bin/env bash

STATUS_ABORTED=10
STATUS_PASSWORD_REQUIRED=11
STATUS_CONNECTION_REFUSED=12

connect_to_known_wifi() {
    echo "Trying to connect to known networks..."

    local known=$(nmcli -t -f NAME,TYPE connection show | grep -i wireless | cut -d ':' -f 1)

    IFS=$'\n'
    for ssid in $known; do
        if [ "$ssid" = "$1" ]; then
            send_in_progress $1
            nmcli connection up "$1"
            return $?
        fi
    done

    return 1
}

send_success() {
    local message="Connected to $1."
    notify-send -u low -a "MCD" "Select Wi-Fi" "$message"
    echo "$message"
}

send_in_progress() {
    local message="Connecting to $1..."
    #notify-send -u low -a "MCD" "Select Wi-Fi" "$message"
    echo "$message"
}

send_failure() {
    local message="Connection to $1 failed."
    notify-send -u critical -a "MCD" "Select Wi-Fi" "$message"
    echo "$message"
}

connected=$(nmcli -t -f name,active,type connection show | grep -i -E 'yes.*wireless' | cut -d : -f 1)
picked=$(mcd-list-wifi | rofi -dmenu -p 'Wi-Fi: ' -i -no-show-icons -mesg "Connected: $connected"| cut -f 2)

if [ -z "$picked" ]; then
    echo "Aborted..."
    exit $STATUS_ABORTED
fi

connect_to_known_wifi "$picked"

if [ $? -eq 0 ]; then
    send_success "$picked"
    exit 0
fi

secured=$(echo "$wifis" | grep -i "$picked" | cut -d ':' -f 4)
password=""

if [ -n "$secured" ]; then
    password=$(rofi -dmenu -p 'Password: ' -password -l 0 -mesg "$picked")
fi

if [ -n "$secured" ] && [ -z "$password" ]; then
    echo "Password required, aborted..."
    exit $STATUS_PASSWORD_REQUIRED
fi

send_in_progress "$picked"

if [ -n "$secured" ]; then
    nmcli device wifi connect "$picked" password "$password"
else
    nmcli device wifi connect "$picked"
fi

if [ "$?" -eq 0 ]; then
    send_success "$picked"
else
    send_failure "$picked"
    exit $STATUS_CONNECTION_REFUSED
fi

exit 0
