#!/usr/bin/env bash

#TODO: Refactor this to the rofi-script version. This cannot handle filtering properly

format_device_icon() {
    while read -r line; do
        local icon_name=$(echo "$line" | cut -d ',' -f 5)
        local icon_glyph=""

        case $icon_name in
            "input-keyboard") icon_glyph="󰌌" ;;
            "input-mouse") icon_glyph="󰍽" ;;
            "audio-card") icon_glyph="󰓃" ;;
            "audio-headset") icon_glyph="󰋋" ;;
            *) icon_glyph="" ;;
        esac

        echo "$line" | sed "s/$icon_name/$icon_glyph/"
    done
}

format_connection_state() {
    while read -r line; do
        local state=$(echo "$line" | cut -d ',' -f 4)
        local state_glyph=""

        if [ "$state" = "connected" ]; then
            state_glyph=""
        fi

        echo "$line" | sed "s/$state/$state_glyph/"
    done
}

format_state_icon() {
    while read -r line; do
        local battery_value=$(echo "$line" | cut -d ',' -f 3)
        local state=$(echo "$line" | cut -d ',' -f 4)
        local state_glyph=""

        if [ "$state" = "connected" ]; then

            if [ -n "$battery_value" ]; then
                if [ $battery_value -gt 90 ]; then
                    state_glyph="󰁹"
                elif [ $battery_value -gt 80 ]; then
                    state_glyph="󰂂"
                elif [ $battery_value -gt 70 ]; then
                    state_glyph="󰂁"
                elif [ $battery_value -gt 60 ]; then
                    state_glyph="󰂀"
                elif [ $battery_value -gt 50 ]; then
                    state_glyph="󰁿"
                elif [ $battery_value -gt 40 ]; then
                    state_glyph="󰁾"
                elif [ $battery_value -gt 30 ]; then
                    state_glyph="󰁽"
                elif [ $battery_value -gt 20 ]; then
                    state_glyph="󰁼"
                elif [ $battery_value -gt 10 ]; then
                    state_glyph="󰁻"
                elif [ $battery_value -gt 0 ]; then
                    state_glyph="󰁺"
                else
                    state_glyph="󰂎"
                fi
            else
                state_glyph=""
            fi
        fi

        echo "$line" | sed "s/$state/$state_glyph/"

    done
}

format_for_rofi() {
    while read -r line; do
        local address=$(echo "$line" | cut -d ',' -f 1)
        local name=$(echo "$line" | cut -d ',' -f 2)
        local state=$(echo "$line" | cut -d ',' -f 4)
        local device_icon=$(echo "$line" | cut -d ',' -f 5)

        local display_value="$device_icon\t$state\t$name"

        echo -en "$address\0display\x1f$display_value\0meta\x1f$name\n"
    done
}

notify_success() {
    if command -v notify-send >/dev/null; then
        notify-send -u low -a "MCD" "Bluetooth" "$1"
    else
        echo "libnotify not found"
    fi

    echo "$1"
}


notify_failure() {
    if command -v notify-send >/dev/null; then
        notify-send -u critical -a "MCD" "Bluetooth" "$1"
    else
        echo "libnotify not found"
    fi

    echo "$1"
}

# Terminate if no bluetoothctl is found
if ! command -v bluetoothctl >/dev/null 2>&1; then
    echo "No bluetoothctl installed."
    exit 1
fi

# Get trusted devices details
devices=$(mcd-list-bluetooth-devices)

# format rofi menu
selected=$(echo "$devices" \
    | format_device_icon \
    | format_state_icon \
    | format_for_rofi \
    | rofi -dmenu -i -no-show-icons -p "Toggle device: ")

if [ -z "$selected" ]; then
    echo "Abort."
    exit 1
fi

selected_name=$(echo "$devices" \
    | grep "$selected" \
    | cut -d ',' -f 2)

# connect if disconnected
if echo "$devices" | grep "$selected" | grep 'disconnected' >/dev/null 2>&1; then
    echo "Connecting $selected"
    if timeout 10 bluetoothctl connect "$selected"; then
        notify_success "$selected_name device connected successfully"
        exit 0
    else
        notify_failure "$selected_name device connection failure"
        exit 1
    fi
#disconnect if connected
else
    echo "Disconnecting $selected"
    if timeout 10 bluetoothctl disconnect "$selected"; then
        notify_success "$selected_name device disconnected successfully"
        exit 0 
    else
        notify_failure "$selected_name device disconnection failure"
        exit 1
    fi
fi


